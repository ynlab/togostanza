$ ->
  RE = /^data-stanza-(.+)/

  $('[data-stanza-type]').each (index) ->
    $this  = $(this)
    data   = $this.data()
    params = {}

    $.each @attributes, (i, attr) ->
      if key = (RE.exec(attr.name) || [])[1]
        params[key.replace('-', '_')] = attr.value

    src = "<%= ENV['SERVER_URL'] %>/stanza/#{data.stanzaType}?#{$.param(stanza_params: params)}"

    $('<iframe></iframe>')
      .attr(src: src, frameborder: 0)
      .attr(id: "stanza-frame-#{index}")
      .attr(name: "stanza-frame-#{index}")
      .width(data.stanzaWidth || '100%')
      .height(data.stanzaHeight)
      .appendTo $this

  window.onmessage = (e) ->
    return null unless (e.origin == "<%= ENV['SERVER_URL'] %>")

    message = JSON.parse(e.data)
    $("##{message.id}").height(message.height)
